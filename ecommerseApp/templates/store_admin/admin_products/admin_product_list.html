{% extends 'store/base.html' %}
{% block content %}
    <div class="container mt-4 admin-view ml-1">
        <h3>All Products - ({{ products|length }})</h3>
        <form method="get" class="mb-3">
            <div class="input-group">
                <input type="text" name="q" class="form-control" placeholder="Search products..."
                       value="{{ search_query }}">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
        <a href="{% url 'product-create' %}" class="btn btn-success">Add product</a>
        <a href="{% url 'products-export-csv' %}" class="btn btn-info">Export products</a>
        <form method="post" action="{% url 'bulk-edit-products' %}" class="product-bulk-edit">
            {% csrf_token %}
            <table class="table table-bordered table-hover mt-3">
                <thead class="table-dark">
                <tr>
                    <th>
                        <input type="checkbox" id="select-all">
                    </th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Model</th>
                    <th>Code</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {% for product in products %}
                    <tr class="clickable-row" data-href="{% url 'product-detail' product.pk %}">
                        <td>
                            <input type="checkbox" name="selected_products" value="{{ product.id }}"
                                   class="product-checkbox">
                        </td>
                        <td>{{ product.id }}</td>
                        <td>{{ product.name }}</td>
                        <td>${{ product.price }}</td>
                        <td>{{ product.model }}</td>
                        <td>{{ product.sku }}</td>
                        <td>{{ product.is_active }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <div class="mt-3">
                <select name="action" class="form-select d-inline w-auto">
                    <option value="">-- Select Action --</option>
                    <option value="activate">Activate</option>
                    <option value="deactivate">Deactivate</option>
                    <option value="delete">Delete</option>
                </select>
                <button type="submit" class="btn btn-primary">Apply</button>
            </div>
        </form>

        <!--Bulk delete confirm form -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-danger">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteConfirmLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to permanently delete the selected products? This action cannot be undone.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button id="confirmDeleteBtn" type="button" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Handle clickable rows
            const rows = document.querySelectorAll(".clickable-row");
            rows.forEach(row => {
                row.addEventListener("click", (e) => {
                    if (e.target.tagName.toLowerCase() !== 'input') {
                        window.location = row.dataset.href;
                    }
                });
            });

            const selectAll = document.getElementById("select-all");
            const checkboxes = document.querySelectorAll(".product-checkbox");

            selectAll.addEventListener("change", function () {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
        });
    </script>

    <script>
        document.querySelector('.product-bulk-edit').addEventListener('submit', function (e) {
            const action = document.querySelector('select[name="action"]').value;

            if (action === 'delete') {
                e.preventDefault();
                
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                deleteModal.show();
                
                document.getElementById('confirmDeleteBtn').onclick = function () {
                    deleteModal.hide();
                    e.target.submit();
                };
            }
        });
    </script>

{% endblock %}
